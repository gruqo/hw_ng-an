# --- МАПА-переключатель методов балансировки
map "" $balance_switch {
    default "rr_active";     # Round Robin
    #default "hash_active";   # Hash-based
    #default "random_active"; # Random
}

# --- МАПА выбора upstream
map $balance_switch $selected_upstream {
    "rr_active"     "backends_rr";
    "hash_active"   "backends_hash";
    "random_active" "backends_random";
    default         "backends_rr";
}

# --- МАПА имен серверов
map $upstream_addr $backend_name {
    "127.0.0.1:8001"    "backend1";
    "127.0.0.1:8002"    "backend2";
    "127.0.0.1:8003"    "backend3";
    "127.0.0.1:8004"    "backup";
    default             $upstream_addr;
}

# --- МАПА отображения метода
map $balance_switch $balance_method_display {
    "rr_active"     "Round Robin";
    "hash_active"   "Hash-based ($http_user_agent)";
    "random_active" "Random (least_conn)";
    default         "Round Robin (default)";
}

# --- UPSTREAM
upstream backends_rr {
    zone backends_rr 1m;
    server 127.0.0.1:8001;
    server 127.0.0.1:8002;
    server 127.0.0.1:8003;
    server 127.0.0.1:8004 backup;
    backup_switch permanent=1m;
}

upstream backends_hash {
    zone backends_hash 1m;
    hash $http_user_agent consistent;
    server 127.0.0.1:8001;
    server 127.0.0.1:8002;
    server 127.0.0.1:8003;
}

upstream backends_random {
    zone backends_random 1m;
    random two least_conn;
    server 127.0.0.1:8001;
    server 127.0.0.1:8002;
    server 127.0.0.1:8003;
}

upstream monitoring {
    zone monitoring_backend 64k;
    server 127.0.0.1:8005;
}

# --- ВИРТУАЛЬНЫЙ СЕРВЕР: для запросов
server {
    listen 80;
    server_name practicum-demo.space;

    access_log /var/log/angie/balancer_access.log combined buffer=32k flush=5s;
    error_log /var/log/angie/balancer_error.log warn;

    location / {
        proxy_pass http://$selected_upstream;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Backend-Server $upstream_addr;
        proxy_set_header X-Backend-Name $backend_name;
        proxy_set_header X-Balance-Method $balance_method_display;
        proxy_set_header X-Health-Check false;

        post_action @log_to_monitoring;

        proxy_connect_timeout 2s;
        proxy_read_timeout 5s;
        proxy_send_timeout 5s;

        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 10s;

        add_header X-Backend-Server $upstream_addr always;
        add_header X-Server-Name $backend_name always;
        add_header X-Balancer-Method $balance_method_display always;
        add_header X-Selected-Upstream $selected_upstream always;
        add_header X-Balance-Switch $balance_switch always;  # Показывает текущий переключатель
    }

    location @log_to_monitoring {
        internal;
        proxy_pass http://127.0.0.1:8005/log_request?backend=$upstream_addr;
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
    }

    error_page   500 502 503 504  /error/50x.html;
    location = /error/50x.html {
        internal;
    }

    location = /favicon.ico {
        access_log off;
        log_not_found off;
        return 204; # No Content
    }

    location ~ /\.(?!well-known) {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ /\.ht {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# --- ВИРТУАЛЬНЫЙ СЕРВЕР: для мониторинга
server {
    listen 443 ssl;
    server_name hw.practicum-demo.space;

    access_log /var/log/angie/monitor_access.log combined buffer=32k flush=5s;
    error_log /var/log/angie/monitor_error.log warn;

    acme rsa;
    acme ecdsa;

    ssl_certificate $acme_cert_rsa;
    ssl_certificate_key $acme_cert_key_rsa;

    ssl_certificate $acme_cert_ecdsa;
    ssl_certificate_key $acme_cert_key_ecdsa;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;

    location / {
        proxy_pass http://monitoring;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Balance-Method $balance_method_display;
    }

    error_page   500 502 503 504  /error/50x.html;
    location = /error/50x.html {
        internal;
    }

    location = /favicon.ico {
        access_log off;
        log_not_found off;
        return 204; # No Content
    }

    location ~ /\.(?!well-known) {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ /\.ht {
        deny all;
        access_log off;
        log_not_found off;
    }
}